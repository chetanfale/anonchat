<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chatroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, deleteDoc, onSnapshot, arrayUnion, arrayRemove, writeBatch, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for detailed console output
        setLogLevel('debug');

        // IMPORTANT: Replace the placeholder values below with your own Firebase project configuration
        // You can find this in your Firebase console under Project settings -> General
        const firebaseConfig = {
              apiKey: "AIzaSyCVL-W9_ZIs6TY97EZ4BcIEK0DwFePb4rE",
  authDomain: "anonchat-53f38.firebaseapp.com",
  projectId: "anonchat-53f38",
  storageBucket: "anonchat-53f38.firebasestorage.app",
  messagingSenderId: "656923009248",
  appId: "1:656923009248:web:e86dd6b3a0a11e90797085",
  measurementId: "G-EWYJXXE8R9"
        };
        const appId = firebaseConfig.projectId;

        // In a real hosting environment, these might be injected, but for local testing,
        // we'll assume they don't exist and use anonymous authentication.
        const initialAuthToken = null;

        let app;
        let db;
        let auth;
        let userId = null;
        let currentRoomId = null;
        let isAdmin = false;
        let memberDisplayNames = {};


        window.onload = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    await handleAuth();
                    setupListeners();
                } else {
                    console.error("Firebase config is missing. Please provide it.");
                }
            } catch (error) {
                console.error("Initialization failed:", error);
            }
        };

        async function handleAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                console.log("Authenticated with user ID:", userId);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }

        function setupListeners() {
            document.getElementById('create-room-btn').addEventListener('click', createRoom);
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('vanish-chats-btn').addEventListener('click', vanishChats);
            document.getElementById('close-room-btn').addEventListener('click', closeRoom);
            document.getElementById('exit-room-btn').addEventListener('click', exitRoom);
            document.getElementById('show-rename-modal-btn').addEventListener('click', () => {
                document.getElementById('rename-modal').classList.remove('hidden');
            });
            document.getElementById('rename-confirm-btn').addEventListener('click', renameMember);
            document.getElementById('rename-cancel-btn').addEventListener('click', () => {
                document.getElementById('rename-modal').classList.add('hidden');
            });
            document.getElementById('change-room-id-btn').addEventListener('click', changeRoomId);

            document.getElementById('message-input').addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('message-input').addEventListener('input', (event) => {
                event.target.style.height = 'auto';
                event.target.style.height = `${event.target.scrollHeight}px`;
            });

             window.addEventListener('beforeunload', async () => {
                if (currentRoomId && userId) {
                    try {
                        const memberRef = doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId);
                        const memberDoc = await getDoc(memberRef);
                        if (memberDoc.exists()) {
                            await updateDoc(memberRef, { isOnline: false });
                        }
                    } catch (error) {
                        console.error("Error setting user offline:", error);
                    }
                }
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function createRoom() {
            const passcode = document.getElementById('passcode-input').value;
            if (!passcode) {
                showMessage('Please enter a passcode.', 'error');
                return;
            }
            try {
                // Check if a room with this passcode already exists
                const q = query(collection(db, `artifacts/${appId}/public/data/chatrooms`), where("passcode", "==", passcode));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const existingRoom = querySnapshot.docs[0].data();
                    if (existingRoom.isActive) {
                        showMessage('A room with this passcode is already active.', 'error');
                        return;
                    }
                }

                const newRoomRef = doc(collection(db, `artifacts/${appId}/public/data/chatrooms`));
                await setDoc(newRoomRef, {
                    roomId: newRoomRef.id,
                    adminId: userId,
                    isActive: true,
                    passcode: passcode,
                    createdAt: Date.now()
                });
                await setDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${newRoomRef.id}/members`, userId), {
                    userId: userId,
                    isMember: true,
                    isOnline: true,
                    displayName: 'Admin',
                    historyAccessTimestamp: Date.now()
                });
                currentRoomId = newRoomRef.id;
                isAdmin = true;
                showMessage(`Room created with ID: ${currentRoomId}`, 'success');
                enterChatroom(currentRoomId);
            } catch (error) {
                console.error("Error creating room:", error);
                showMessage('Failed to create room.', 'error');
            }
        }

        async function joinRoom() {
            const name = document.getElementById('join-name-input').value;
            const roomId = document.getElementById('join-room-id-input').value;
            const passcode = document.getElementById('join-passcode-input').value;

            if (!name || !roomId || !passcode) {
                showMessage('Please enter your name, room ID, and passcode.', 'error');
                return;
            }
            try {
                const roomDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, roomId));
                if (!roomDoc.exists() || roomDoc.data().passcode !== passcode) {
                    showMessage('Invalid room ID or passcode.', 'error');
                    return;
                }
                if (!roomDoc.data().isActive) {
                    showMessage('The chatroom is closed.', 'error');
                    return;
                }

                currentRoomId = roomId;
                const membersRef = collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`);
                const membersSnapshot = await getDocs(membersRef);

                const memberDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId));
                if (memberDoc.exists()) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId), { isOnline: true });
                    enterChatroom(currentRoomId);
                    return;
                }
                
                if (membersSnapshot.empty) {
                    // No members in the room, join automatically
                    await setDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId), {
                        userId: userId,
                        isMember: true,
                        isOnline: true,
                        displayName: name,
                        historyAccessTimestamp: null
                    });
                    enterChatroom(currentRoomId);
                } else {
                    // Members are present, send a join request and listen for approval
                    await setDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/requests`, userId), {
                        userId: userId,
                        displayName: name,
                        timestamp: Date.now()
                    });
                    showMessage('Your join request has been sent to the admin. Please wait for approval.', 'info');
                    
                    const unsubscribe = onSnapshot(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId), (memberDoc) => {
                        if (memberDoc.exists()) {
                            unsubscribe(); // Stop listening once approved
                            showMessage('Your request has been approved!', 'success');
                            enterChatroom(currentRoomId);
                        }
                    });
                }
            } catch (error) {
                console.error("Error joining room:", error);
                showMessage('Failed to join room.', 'error');
            }
        }

        async function enterChatroom(roomId) {
            showScreen('chatroom-screen');
            document.getElementById('room-id-display').innerText = `Room ID: ${roomId}`;
            document.getElementById('user-id-display').innerText = `Your ID: ${userId}`;
            
            try {
                const roomDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, roomId));
                isAdmin = roomDoc.data().adminId === userId;
            } catch (error) {
                console.error("Error determining admin status:", error);
            }

            if (isAdmin) {
                document.getElementById('admin-controls').classList.remove('hidden');
            } else {
                document.getElementById('admin-controls').classList.add('hidden');
            }
            
            onSnapshot(collection(db, `artifacts/${appId}/public/data/chatrooms/${roomId}/requests`), async (snapshot) => {
                const requestsList = document.getElementById('requests-list');
                requestsList.innerHTML = '';
                const roomDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, roomId));
                isAdmin = roomDoc.data().adminId === userId;
                if (snapshot.docs.length > 0) {
                    document.getElementById('requests-container').classList.remove('hidden');
                } else {
                    document.getElementById('requests-container').classList.add('hidden');
                }
                snapshot.forEach(doc => {
                    const requestData = doc.data();
                    const requestElement = document.createElement('div');
                    requestElement.className = 'flex justify-between items-center p-2 bg-gray-700 rounded-lg mb-2';
                    
                    let buttonsHtml = '';
                    if (isAdmin) {
                        buttonsHtml = `
                            <button onclick="handleRequest('${doc.id}', true, '${requestData.displayName}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full mr-2">Accept</button>
                            <button onclick="handleRequest('${doc.id}', false)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full">Decline</button>
                        `;
                    }

                    requestElement.innerHTML = `
                        <span>${requestData.displayName || requestData.userId} wants to join.</span>
                        <div>${buttonsHtml}</div>
                    `;
                    requestsList.appendChild(requestElement);
                });
            });

            // Real-time listener for current user's membership to handle kicks
            onSnapshot(doc(db, `artifacts/${appId}/public/data/chatrooms/${roomId}/members`, userId), (doc) => {
                if (!doc.exists()) {
                    // User has been kicked or left. Exit the room.
                    document.getElementById('chat-input-area').classList.add('hidden'); // Hide input
                    showMessage('You have been removed from the chatroom.', 'error');
                    setTimeout(() => {
                        exitRoom();
                    }, 3000); // Wait 3 seconds before exiting
                }
            });

            // Real-time listeners for room status
            onSnapshot(doc(db, `artifacts/${appId}/public/data/chatrooms`, roomId), (doc) => {
                const room = doc.data();
                if (room && !room.isActive) {
                    document.getElementById('chat-input-area').classList.add('hidden');
                    showMessage('The chatroom has been closed by the admin.', 'info');
                } else {
                    document.getElementById('chat-input-area').classList.remove('hidden');
                }
                // Update the room ID display in case the admin changes it
                document.getElementById('room-id-display').innerText = `Room ID: ${room.roomId}`;
            });

            onSnapshot(collection(db, `artifacts/${appId}/public/data/chatrooms/${roomId}/members`), (snapshot) => {
                const membersList = document.getElementById('members-list');
                membersList.innerHTML = '';
                memberDisplayNames = {}; // Reset the map
                snapshot.forEach(doc => {
                    const memberData = doc.data();
                    const displayName = memberData.displayName || memberData.userId;
                    memberDisplayNames[memberData.userId] = displayName; // Store the display name
                    const memberElement = document.createElement('li');
                    
                    const statusColor = memberData.isOnline ? 'bg-green-500' : 'bg-red-500';
                    memberElement.className = 'p-2 bg-gray-700 rounded-lg mb-2 flex justify-between items-center';
                    
                    let kickButtonHtml = '';
                    if (isAdmin && memberData.userId !== userId) {
                         kickButtonHtml = `<button onclick="kickMember('${memberData.userId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full">Kick</button>`;
                    }

                    memberElement.innerHTML = `<div class="flex items-center space-x-2"><span class="w-2 h-2 rounded-full ${statusColor}"></span><span>${memberData.userId === userId ? `${displayName} (You)` : displayName}</span></div> ${kickButtonHtml}`;
                    membersList.appendChild(memberElement);
                });
            });
            
            const messagesQuery = query(collection(db, `artifacts/${appId}/public/data/chatrooms/${roomId}/messages`), orderBy("timestamp"));

            onSnapshot(messagesQuery, async (snapshot) => {
                const messagesList = document.getElementById('messages-list');
                const tempMessages = []; // Temporary array to hold messages before rendering

                const memberDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId));
                const memberData = memberDoc.data();
                
                // Get the timestamp from the user's document for when they last gained history access
                const historyAccessTimestamp = memberData.historyAccessTimestamp;

                // Render all messages from the snapshot
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    
                    // Only show messages if the user has history access, or if the message is from a system-bot or the current user.
                    if (historyAccessTimestamp !== null) {
                        const messageElement = document.createElement('div');
                        if (messageData.userId === 'system-bot') {
                             messageElement.className = 'p-3 rounded-lg my-2 text-center bg-gray-600 text-white break-words whitespace-pre-wrap';
                             messageElement.innerHTML = `<pre>${messageData.text}</pre>`;
                        } else {
                            messageElement.className = `p-3 rounded-lg my-2 max-w-[80%] break-words whitespace-pre-wrap ${messageData.userId === userId ? 'bg-purple-600 text-white ml-auto' : 'bg-gray-700 text-gray-100 mr-auto'}`;
                            const senderDisplayName = memberDisplayNames[messageData.userId] || messageData.userId; // Use the stored display name
                            messageElement.innerText = `${messageData.userId === userId ? 'You' : senderDisplayName}: ${messageData.text}`;
                        }
                        tempMessages.push(messageElement);
                    } else if (messageData.userId === 'system-bot' || messageData.userId === userId) {
                         const messageElement = document.createElement('div');
                         if (messageData.userId === 'system-bot') {
                             messageElement.className = 'p-3 rounded-lg my-2 text-center bg-gray-600 text-white break-words whitespace-pre-wrap';
                             messageElement.innerHTML = `<pre>${messageData.text}</pre>`;
                         } else {
                             messageElement.className = `p-3 rounded-lg my-2 max-w-[80%] break-words whitespace-pre-wrap ${messageData.userId === userId ? 'bg-purple-600 text-white ml-auto' : 'bg-gray-700 text-gray-100 mr-auto'}`;
                             const senderDisplayName = memberDisplayNames[messageData.userId] || messageData.userId;
                             messageElement.innerText = `${messageData.userId === userId ? 'You' : senderDisplayName}: ${messageData.text}`;
                         }
                         tempMessages.push(messageElement);
                    }
                });
                
                messagesList.innerHTML = ''; // Clear all messages before rendering
                tempMessages.forEach(el => messagesList.appendChild(el));
                messagesList.scrollTop = messagesList.scrollHeight;
            });
        }
        
        window.kickMember = async (memberToKickId) => {
            if (!currentRoomId || !isAdmin) return;
            try {
                const memberRef = doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, memberToKickId);
                await deleteDoc(memberRef);
                showMessage(`Successfully kicked member ${memberToKickId}.`, 'success');
            } catch (error) {
                console.error("Error kicking member:", error);
                showMessage('Failed to kick member.', 'error');
            }
        };

        window.handleRequest = async (requestId, accept, displayName) => {
            if (!currentRoomId || !isAdmin) return;
            const requestRef = doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/requests`, requestId);
            try {
                const requestDoc = await getDoc(requestRef);
                if (!requestDoc.exists()) return;
                const requesterId = requestDoc.data().userId;
                
                if (accept) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, requesterId), {
                        userId: requesterId,
                        isMember: true,
                        isOnline: true,
                        displayName: displayName || requesterId,
                        historyAccessTimestamp: null // New users don't see history by default
                    });
                }
                await deleteDoc(requestRef);
            } catch (error) {
                console.error("Error handling request:", error);
                showMessage('Failed to handle request.', 'error');
            }
        };

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            if (messageText === '') return;
            
            // Check if the user is a member before sending
            const memberDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId));
            if (!memberDoc.exists()) {
                 showMessage('You are not a member of this chatroom and cannot send messages.', 'error');
                 return;
            }

            // Command: /getbac
            if (messageText.toLowerCase() === '/getbac') {
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId), {
                        historyAccessTimestamp: Date.now()
                    });
                     await addDoc(collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`), {
                        userId: 'system-bot',
                        text: `${memberDoc.data().displayName || userId} has gained access to chat history.`,
                        timestamp: Date.now()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error granting history access:", error);
                    showMessage('Failed to get history access.', 'error');
                }
                return;
            }

            // Command: /getid
            if (messageText.toLowerCase() === '/getid') {
                const membersRef = collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`);
                const membersSnapshot = await getDocs(membersRef);
                let memberListMessage = "Member IDs:\n";
                membersSnapshot.forEach(doc => {
                    const memberData = doc.data();
                    const displayName = memberData.displayName || memberData.userId;
                    memberListMessage += `${displayName}: ${memberData.userId}\n`;
                });
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`), {
                    userId: 'system-bot',
                    text: memberListMessage,
                    timestamp: Date.now()
                });
                messageInput.value = '';
                return;
            }

            // Command: /getadmin
            if (messageText.toLowerCase() === '/getadmin') {
                if (isAdmin) {
                    showMessage('You are already the admin.', 'info');
                    messageInput.value = '';
                    return;
                }
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, currentRoomId), { adminId: userId });
                    isAdmin = true;
                    await addDoc(collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`), {
                        userId: 'system-bot',
                        text: `Admin access granted to ${memberDoc.data().displayName || userId}.`,
                        timestamp: Date.now()
                    });
                    showMessage('You have been granted admin access.', 'success');
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error granting admin access:", error);
                    showMessage('Failed to get admin access.', 'error');
                }
                return;
            }

            // Command: /killhouse
            if (messageText.toLowerCase() === '/killhouse') {
                if (!isAdmin) {
                    showMessage('This is an admin-only command.', 'error');
                    messageInput.value = '';
                    return;
                }
                
                showMessage('Initiating killhouse protocol...', 'info');
                await vanishChats();
                await closeRoom();

                const newPasscode = Math.random().toString(36).substring(2, 8);
                const newRoomRef = doc(collection(db, `artifacts/${appId}/public/data/chatrooms`));
                await setDoc(newRoomRef, {
                    roomId: newRoomRef.id,
                    adminId: userId,
                    isActive: true, 
                    passcode: newPasscode,
                    createdAt: Date.now()
                });
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`), {
                    userId: 'system-bot',
                    text: `Killhouse protocol complete. All chats vanished and room closed.\n\nA new secret room has been generated.\nNew Room ID: ${newRoomRef.id}\nPasscode: ${newPasscode}`,
                    timestamp: Date.now()
                });

                messageInput.value = '';
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`), {
                    userId: userId,
                    text: messageText,
                    timestamp: Date.now()
                });
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showMessage('Failed to send message.', 'error');
            }
        }

        async function vanishChats() {
            if (!isAdmin || !currentRoomId) return;
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/messages`);
                const messagesSnapshot = await getDocs(messagesRef);
                const batch = writeBatch(db);
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showMessage('All messages have been vanished.', 'success');
            } catch (error) {
                console.error("Error vanishing chats:", error);
                showMessage('Failed to vanish chats.', 'error');
            }
        }

        async function closeRoom() {
            if (!isAdmin || !currentRoomId) return;
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, currentRoomId), { isActive: false }, { merge: true });
                showMessage('Chatroom has been closed.', 'success');
            } catch (error) {
                console.error("Error closing room:", error);
                showMessage('Failed to close room.', 'error');
            }
        }

        async function changeRoomId() {
            const newRoomId = document.getElementById('new-room-id-input').value.trim();
            if (!newRoomId) {
                showMessage('Please enter a new Room ID.', 'error');
                return;
            }
            if (!currentRoomId || !isAdmin) {
                showMessage('You are not the admin or in a chatroom.', 'error');
                return;
            }

            try {
                // Check if new Room ID is already in use
                const roomDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/chatrooms`, newRoomId));
                if (roomDoc.exists()) {
                    showMessage('This Room ID is already taken. Please choose another.', 'error');
                    return;
                }

                const batch = writeBatch(db);
                const oldRoomRef = doc(db, `artifacts/${appId}/public/data/chatrooms`, currentRoomId);
                const newRoomRef = doc(db, `artifacts/${appId}/public/data/chatrooms`, newRoomId);

                // Copy main room document to new ID
                const oldRoomData = (await getDoc(oldRoomRef)).data();
                batch.set(newRoomRef, { ...oldRoomData, roomId: newRoomId });

                // Copy all subcollections
                const collectionsToCopy = ['members', 'requests', 'messages'];
                for (const col of collectionsToCopy) {
                    const oldDocs = await getDocs(collection(oldRoomRef, col));
                    oldDocs.forEach(d => {
                        batch.set(doc(newRoomRef, col, d.id), d.data());
                    });
                }
                
                // Delete old room document
                batch.delete(oldRoomRef);
                
                await batch.commit();
                
                currentRoomId = newRoomId;
                showMessage(`Room ID successfully changed to ${newRoomId}.`, 'success');

                // Update UI without full page reload
                document.getElementById('room-id-display').innerText = `Room ID: ${currentRoomId}`;

            } catch (error) {
                console.error("Error changing Room ID:", error);
                showMessage('Failed to change Room ID.', 'error');
            }
        }

        async function renameMember() {
            const memberId = document.getElementById('rename-member-id').value.trim();
            const newName = document.getElementById('rename-new-name').value.trim();
            if (!memberId || !newName) {
                showMessage('Please enter both a member ID and a new name.', 'error');
                return;
            }
            if (!currentRoomId || !isAdmin) {
                showMessage('You are not the admin or in a chatroom.', 'error');
                return;
            }

            try {
                const memberRef = doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, memberId);
                const memberDoc = await getDoc(memberRef);

                if (!memberDoc.exists()) {
                    showMessage('Member not found.', 'error');
                    return;
                }

                await updateDoc(memberRef, {
                    displayName: newName
                });
                showMessage(`Successfully renamed ${memberId} to ${newName}.`, 'success');
                document.getElementById('rename-modal').classList.add('hidden');
                document.getElementById('rename-member-id').value = '';
                document.getElementById('rename-new-name').value = '';
            } catch (error) {
                console.error("Error renaming member:", error);
                showMessage('Failed to rename member.', 'error');
            }
        }

        async function exitRoom() {
            if (currentRoomId && userId) {
                 const memberRef = doc(db, `artifacts/${appId}/public/data/chatrooms/${currentRoomId}/members`, userId);
                 await updateDoc(memberRef, { isOnline: false });
            }

            currentRoomId = null;
            isAdmin = false;
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('messages-list').innerHTML = ''; 
            document.getElementById('members-list').innerHTML = '';
            document.getElementById('requests-list').innerHTML = '';
            showScreen('home-screen');
        }

        function showMessage(text, type) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = text;
            msgBox.className = 'absolute top-5 left-1/2 -translate-x-1/2 p-4 rounded-lg shadow-lg z-50';
            if (type === 'error') {
                msgBox.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                msgBox.classList.add('bg-green-500', 'text-white');
            } else {
                msgBox.classList.add('bg-blue-500', 'text-white');
            }
            msgBox.classList.remove('hidden');
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 3000);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        /* Custom scrollbar for chat messages */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2D3748;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Message Box -->
    <div id="message-box" class="hidden"></div>

    <!-- Rename Member Modal -->
    <div id="rename-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-center text-purple-400">Rename Member</h2>
            <input id="rename-member-id" type="text" placeholder="Member ID to rename" class="w-full p-3 rounded-lg mb-4 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <input id="rename-new-name" type="text" placeholder="New display name" class="w-full p-3 rounded-lg mb-4 bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <div class="flex justify-between space-x-4">
                <button id="rename-confirm-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold transition-colors">Confirm</button>
                <button id="rename-cancel-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg font-bold transition-colors">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Home Screen -->
    <div id="home-screen" class="screen w-full max-w-sm p-8 bg-gray-800 rounded-2xl shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-purple-400">Secure Chatroom</h1>
        
        <!-- Create Room Section -->
        <div class="mb-8 p-6 bg-gray-700 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-center">Create New Chatroom</h2>
            <input id="passcode-input" type="text" placeholder="Enter a passcode" class="w-full p-3 rounded-lg mb-4 bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button id="create-room-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-bold transition-colors">Create Room</button>
        </div>

        <!-- Join Room Section -->
        <div class="p-6 bg-gray-700 rounded-xl shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-center">Join Existing Chatroom</h2>
            <input id="join-name-input" type="text" placeholder="Enter your name" class="w-full p-3 rounded-lg mb-2 bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="join-room-id-input" type="text" placeholder="Enter Room ID" class="w-full p-3 rounded-lg mb-2 bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="join-passcode-input" type="text" placeholder="Enter Passcode" class="w-full p-3 rounded-lg mb-4 bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="join-room-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold transition-colors">Join Room</button>
        </div>
        
        <p id="join-request-sent" class="hidden mt-4 text-sm text-center text-yellow-400">Your join request has been sent to the admin.</p>
    </div>

    <!-- Chatroom Screen -->
    <div id="chatroom-screen" class="screen hidden w-full max-w-4xl h-[90vh] flex flex-col bg-gray-800 rounded-2xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-purple-400">
                <span id="room-id-display">Room ID: </span>
            </h1>
            <p id="user-id-display" class="text-xs text-gray-400"></p>
            <button id="exit-room-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors">Exit</button>
        </div>
        
        <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
            <!-- Main Chat Area -->
            <div class="flex flex-col flex-1 bg-gray-900 rounded-xl p-4 overflow-hidden md:mr-4 mb-4 md:mb-0">
                <div id="messages-list" class="flex-1 overflow-y-auto mb-4 custom-scrollbar"></div>
                <div id="chat-input-area" class="flex flex-col md:flex-row items-end">
                    <textarea id="message-input" placeholder="Type your message..." class="flex-1 p-3 rounded-l-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none h-auto min-h-[50px]"></textarea>
                    <button id="send-message-btn" class="bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-r-lg font-bold transition-colors w-full md:w-auto">Send</button>
                </div>
            </div>
            
            <!-- Side Panel -->
            <div class="w-full md:w-1/3 flex flex-col">
                <!-- Members List -->
                <div class="flex-1 bg-gray-900 rounded-xl p-4 mb-4">
                    <h2 class="text-lg font-semibold mb-2">Members</h2>
                    <ul id="members-list" class="space-y-2 overflow-y-auto max-h-40 md:max-h-full"></ul>
                </div>

                <!-- Admin Controls -->
                <div id="admin-controls" class="hidden bg-gray-900 rounded-xl p-4 mb-4">
                    <h2 class="text-lg font-semibold mb-2 text-purple-400">Admin Controls</h2>
                    <div class="flex flex-col space-y-2">
                        <button id="vanish-chats-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-bold transition-colors">Vanish All Chats</button>
                        <button id="close-room-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-bold transition-colors">Close Chatroom</button>
                        <button id="show-rename-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold transition-colors">Rename Member</button>
                        <div class="flex flex-col space-y-2 mt-4">
                            <input id="new-room-id-input" type="text" placeholder="New Room ID" class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="change-room-id-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold transition-colors">Change Room ID</button>
                        </div>
                    </div>
                </div>
                
                <!-- Join Requests -->
                <div id="requests-container" class="hidden bg-gray-900 rounded-xl p-4">
                    <h2 class="text-lg font-semibold mb-2 text-purple-400">Join Requests</h2>
                    <div id="requests-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
